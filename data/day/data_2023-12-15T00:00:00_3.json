{
    "data": {
        "search": {
            "edges": [
                {
                    "node": {
                        "number": 875,
                        "title": "feature/pos-syncing-and-steady-state",
                        "repository": {
                            "nameWithOwner": "deso-protocol/core",
                            "primaryLanguage": {
                                "name": "Go"
                            }
                        },
                        "createdAt": "2023-12-16T17:59:41Z",
                        "mergedAt": "2024-02-07T20:39:14Z",
                        "url": "https://github.com/deso-protocol/core/pull/875",
                        "state": "MERGED",
                        "author": {
                            "login": "tholonious"
                        },
                        "editor": null,
                        "body": "",
                        "reviews": {
                            "edges": [
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Hmm seed hex not mnemonic? I guess because (mnemonic)->seedHex is a one-way operation, so everyone will have the latter but NOT everyone will have the former right?",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1452664410",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "84a22d2",
                                                            "authoredDate": "2024-01-10T17:32:07Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "So I think we're modifying the bestHeaderChain independent of the bestChain, even though we want them to be in-sync. I think it's fine, just feels a bit scary to have two things that need to remain consistent being modified independently.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1452844792",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "84a22d2",
                                                            "authoredDate": "2024-01-10T17:32:07Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Ugh it deleted this long comment I wrote and now I have to type it again... I was saying that this could break frontends because they have the following flow:\n\nBackend constructs txn and sends it to frontend to sign\nFrontend signs and sends to /submit-transaction\n/submit-transaction calls BroadcastTransaction (this thing) and returns\nThen the frontend refreshes under the assumption the txn is in the mempool and its effect will show up after the refresh.\n\nIf we delete this thing then it could cause frontends to miss the txn's effect on refresh. A few ways to fix this:\n\nHave frontend wait for inclusion in a block, which will take a bit of time. Not a big deal. We could wait for a post but maybe not a diamond or things like that.\nAlternatively we could be smarter about how we render things in the mempool in the frontend.\n\nI don't think we have to worry about this for now. I'm just mentioning for when you encounter it later.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1452848504",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "84a22d2",
                                                            "authoredDate": "2024-01-10T17:32:07Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "I've been thinking about this. Better to make it a param or flag? I think flag to start would be good so we can tune it. Eventually for Revolution it needs to be more static, but that can wait...",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1452852985",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "84a22d2",
                                                            "authoredDate": "2024-01-10T17:32:07Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "I will come back to this, but we used to use this in the steady-state to keep the node in sync as follows:\n\nWe call GetHeaders on a peer\nThey send us a header bundle\nBased on that we may or may not fetch a block\n\nIf we're not doing the above, then we must have a different way of fetchin ga block when the consensus is running. Is this because blocks are \"pushed\" to us? I'll keep reading.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1452855266",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "84a22d2",
                                                            "authoredDate": "2024-01-10T17:32:07Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "I think there could be a problem if you hold the the ChainLock.RLock() while you wait for this thing. Maybe not. It does take like a whole second or two, though, and I think kindof bad to hold the RLock for that long maybe idk. Think about it.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1452858510",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "84a22d2",
                                                            "authoredDate": "2024-01-10T17:32:07Z"
                                                        }
                                                    }
                                                },
                                                {
                                                    "node": {
                                                        "bodyText": "This makes me a little nervous as there might be edge cases where it's rejected that we haven't thought of, but I can't think of any so probably OK.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1452868076",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "84a22d2",
                                                            "authoredDate": "2024-01-10T17:32:07Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Huh. That's all we had to add eh? Pretty elegant...",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1452868783",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "84a22d2",
                                                            "authoredDate": "2024-01-10T17:32:07Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Mention why we need this. I saw it but nice to have it there.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1452879464",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "84a22d2",
                                                            "authoredDate": "2024-01-10T17:32:07Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Hmm, good call. We really only need to hold the ChainLock.RLock() while reading the blockTip's height. I've updated the code to reflect that",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1456051682",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "84a22d2",
                                                            "authoredDate": "2024-01-10T17:32:07Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Yup. That's all we need to integrate the new consensus :)",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1456055369",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "84a22d2",
                                                            "authoredDate": "2024-01-10T17:32:07Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "AFAIK, there isn't a standard derivation path to convert a BIP39 seed phrase to BLS private key. So we use the standard seedHex -> bls.PrivKey conversion provided by the FlowCrypto package.",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1456063493",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "84a22d2",
                                                            "authoredDate": "2024-01-10T17:32:07Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Done.",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1456067757",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "84a22d2",
                                                            "authoredDate": "2024-01-10T17:32:07Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Yes, we want to make this a flag that's easily tunable via ENV variables. The comment to make it a param was just ambiguous. I've fixed it",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1456081777",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "84a22d2",
                                                            "authoredDate": "2024-01-10T17:32:07Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Agreed. If a txn is accepted by the PoW mempool, then it must be accepted by the PoS mempool too. The PoS mempool has a strictly relaxed set of txn acceptance rules compared to its PoW counterpart. I can't think of any edge cases either, so this should be safe",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1456089539",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "84a22d2",
                                                            "authoredDate": "2024-01-10T17:32:07Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Yes! We have a different and simpler way of fetching blocks once the new consensus is running:\n\nBlocks are pushed to us without us having to request them in the new consensus\nWhenever we see an orphan block with an unknown ancestor, we request the missing ancestor a peer until we have a fully connected chain",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1456095635",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "84a22d2",
                                                            "authoredDate": "2024-01-10T17:32:07Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Hmm, I'm not sure this is much of an issue. I did notice in ProcessBlockPoW that we call processHeaderPoW in a way that mutates the bestHeaderChain independently, so I figured this would be safe.\nI'll noodle on this to see if we can better couple mutations to the bestChain and bestHeaderChain here while keeping the reorgs simple. LMK if you have a strong opinion on this one",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1456099796",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "84a22d2",
                                                            "authoredDate": "2024-01-10T17:32:07Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Start this out as a configurable flag on the node.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1460171949",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "10c2aa5",
                                                            "authoredDate": "2024-01-19T18:03:35Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "This seems like it should totally work, but a thought I had is it may be inefficient in the sense that you will do a lot of round-trips if you get a far-ahead block. For example, if the peer has A -> B -> C -> D -> E -> F and you're at just A and the peer sends you F, then you will try to connect F, fail, then request E, then you'll get E, try to connect it fail and request D, and so on. I don't think we need to optimize this right now because nodes will generally be nearly-synced at this stage. But leave a comment that this behavior exists if it's correct.\nOne way to fix this is to send your tip inside the GetBlocks message, and then the node can auto-send you everything from your tip to its tip. But again I think this is probably a premature optimization we don't need to make right now. If you like that optimization then leave it as a TODO for fun.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1460183510",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "10c2aa5",
                                                            "authoredDate": "2024-01-19T18:03:35Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Btw just added context: The above suggestion is a simplified version of what GetHeaders does. The GetHeaders thing does a sophisticated \"common ancestor\" check between the two nodes by sending an exponentially-backed-off list of your headers, eg: tip, tip-1, tip-2, tip-4, tip-8, tip-16, ..., genesis. This covers cases where nodes are super divergent, which can happen in Bitcoin but can't happen in PoS so it doesn't make sense to port it over. Instead, sending the committed tip only, and then having the node send you its next N blocks from the tip automatically, seems like the \"most right\" thing to do with PoS. But again I think what you have works and just adding a TODO is good and will work great.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1460185114",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "10c2aa5",
                                                            "authoredDate": "2024-01-19T18:03:35Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Hmmm... it feels like you don't need to store the safe blocks on the fc object. Rather, you can just compute them on the fly from the blockchain object every time. This would be like a tiny bit less efficient, but it would also be less redundant and less error-prone.\nIs there a reason you want to store and update a list of safeblocks on the fc object rather than recomputing them on the fly every time?",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1460195510",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "10c2aa5",
                                                            "authoredDate": "2024-01-19T18:03:35Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Ah I see... it looks like the FastHotStuffEventLoop is distinct from the FastHotStuffConsensus object, and the former doesn't have a blockchain object, which is why you have to do this update manually. This makes sense, and I like the design because it makes it much easier to test the consensus code.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1460196199",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "10c2aa5",
                                                            "authoredDate": "2024-01-19T18:03:35Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Ok but I'm still confused about something. Don't you always need to call UpdateSafeBlocks, even if the new block was added to the tip? I'm not seeing where FastHotStuffEventLoop.safeBlocks gets updated in the case where we just attach a block to the tip, even though I think we should be adding the tip block to safeBlocks in that case.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1460200230",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "10c2aa5",
                                                            "authoredDate": "2024-01-19T18:03:35Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Sorry nevermind. It's a few lines later, and gets updated in FastHotStuffEventLoop.ProcessTipBlock().",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1460200408",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "10c2aa5",
                                                            "authoredDate": "2024-01-19T18:03:35Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Just a heads-up. By the time we get here, we're guaranteed that our tip will be within MaxTipAge of the \"true\" tip on the network, where MaxTipAge is 24h. Specifically, the order is: 1) sync all the headers, 2) download all the blocks for those headers, 3) the next thing that would trigger with your code is _handleBlock().\nIf we assume the above, then we could potentially be an hour or more behind at step (2) causing the first tip block we get to do a lot of catch-up. I think this is probably fine, since an hour of blocks is only 3600 little blocks. But it's something to keep in mind as your testing. And if it's slow or suboptimal, you can do the update to add your committed tip to GetBlocks() that I mentioned previously.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1460218176",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "10c2aa5",
                                                            "authoredDate": "2024-01-19T18:03:35Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Reading through a bit more, I think something a bit odd that could happen is you could hit some weird timeouts if you call fastHotStuffConsensus.Start() before that last hour or two of blocks has been downloaded. It seems like it would figure itself out, but just be aware of this as you start testing.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1460232024",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "10c2aa5",
                                                            "authoredDate": "2024-01-19T18:03:35Z"
                                                        }
                                                    }
                                                },
                                                {
                                                    "node": {
                                                        "bodyText": "Something I couldn't figure out yet is where we broadcast votes/timeouts to our peers. I think maybe you haven't done this yet because it relies on the connection management stuff.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1460235845",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "10c2aa5",
                                                            "authoredDate": "2024-01-19T18:03:35Z"
                                                        }
                                                    }
                                                },
                                                {
                                                    "node": {
                                                        "bodyText": "Hmm... so BIP39 is actually supposed to go from mnemonic -> seedHex, not to be confused with bip32 which deals with derivation paths and things like that. You can open identity and hit \"advanced\" on the part where it shows you a seed phrase and then see how it converts it:\nhttps://ibb.co/wwW1rKH\nMy thinking is it would probably be good to make it so that the flag is a mnemonic, and that the seed hex used is identical to that generated by identity, which is standard bip39 generation.\nI could also see the argument for keeping it as raw seed hex. In that case we'll just have to tell people to copy it from the advanced section or something. Also it feels easier to lose a seed hex than a mnemonic but idk.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1460246030",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "84a22d2",
                                                            "authoredDate": "2024-01-10T17:32:07Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "There should be a function somewhere that's like MnemonicToSeed or SeedToMnemonic",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1460246261",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "84a22d2",
                                                            "authoredDate": "2024-01-10T17:32:07Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Yes, this requires the connection management code to be complete. For now, I independently implemented the consensus and added TODO's at the exact lines where network messages would be broadcast. The network send calls will be plug-and-play once Piotr has finished the networking code.",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1462538957",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "10c2aa5",
                                                            "authoredDate": "2024-01-19T18:03:35Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Oh, I like this. And agreed that a seed phrase is easier to manage for node operators, vs a more arbitrary seed hex. The one thing I'm not sure of is whether the seed hex generated via BIP39 matches the number of bytes that the bls private key expects. I'll try to update to this.",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1462541512",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "84a22d2",
                                                            "authoredDate": "2024-01-10T17:32:07Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Implemented in PR #946",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1465473483",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "84a22d2",
                                                            "authoredDate": "2024-01-10T17:32:07Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Implemented in PR #949",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1466595361",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "10c2aa5",
                                                            "authoredDate": "2024-01-19T18:03:35Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Your understanding of the block by block roundtrip to sync A ... F is correct. It is inefficient, but my expectation was also that by the time a validator is in the steady state consensus, it will be nearly synced with all of its peers that this isn't an issue.\n\nOne way to fix this is to send your tip inside the GetBlocks message, and then the node can auto-send you everything from your tip to its tip. But again I think this is probably a premature optimization we don't need to make right now. If you like that optimization then leave it as a TODO for fun.\n\nYour comment is a big unlock for better optimizing the syncing here. I'll add the TODO with context + link to this comment. This will be a straightforward optimization if we ever need it.",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1466628141",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "10c2aa5",
                                                            "authoredDate": "2024-01-19T18:03:35Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "You're right, this totally breaks the frontends. I'm seeing it already on regtest. cc: @lazynina since this is something we'll need to solve.\nPast discussions on this landed on optimistic UI updates for less critical and idempotent txns (posts, comments, likes,...) and to wait for block confirmation for more sensitive txns (basic transfers, limit order,...). The state syncer was the natural place to do optimistic updates. As a v0 solution though, maybe it's fine to wait for one block conf for everything cc: @lazynina so you're aware",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1468263782",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "84a22d2",
                                                            "authoredDate": "2024-01-10T17:32:07Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "On second review, updating the bestChain in lockstep with the bestHeaderChain here is fine. It's turns out to be a no-op from the context of running processBlockPoS because the bestHeaderChain always ends up with the same final state as the bestChain. But the peace of mind of updating them in lockstep here is a nice to have. I've addressed your feedback in #962",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1470073442",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "84a22d2",
                                                            "authoredDate": "2024-01-10T17:32:07Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Added the comment here: #963",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1470143215",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "10c2aa5",
                                                            "authoredDate": "2024-01-19T18:03:35Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Yes, this will figure itself out! Consecutive timeouts have exponential backoff, so a node that's timing out will have its view increment more slowly than the rest of the network. After 2-3 views, the timed out node will have a lower view than the rest of the network, so it will accept the rest of the network's higher view blocks",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1470151209",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "10c2aa5",
                                                            "authoredDate": "2024-01-19T18:03:35Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "The only caveat is that depending on how far back the timed out node is it, the syncing may be inefficient. It's the same inefficiency you pointed out in #875 (comment)\nI think that's an optimization we can defer for the future depending on testing looks on devnet",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1470153615",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "10c2aa5",
                                                            "authoredDate": "2024-01-19T18:03:35Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Something I was telling Zordon is we should make it so these arguments accept EITHER a \"seed hex\" OR a \"seed phrase.\" Not sure if you want to do that here, but I'm mentioning as it came in handy elsewhere. I think he made it so that if it starts with 0x, he reads it as a seed hex, otherwise he reads it as a seed phrase.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1475489288",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "c405758",
                                                            "authoredDate": "2024-02-01T22:58:30Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Hmm... is it better for these to be flags or for them to be ParamUpdater? I'm thinking about how we would change these values later, for example if we want to reduce the block production interval to 1s or even faster if we think the network can handle it.\nRight now, there's not really a good upgrade path here. You would need everyone to upgrade their flags at the exact same time or else the network would break. I think originally we said we'd put these in ParamUpdater for this reason, since it can safely change these values.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1475491774",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "c405758",
                                                            "authoredDate": "2024-02-01T22:58:30Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Separate question is whether we should start this number low and increase it OR start it high and decrease it. I thought about it, and it feels like starting LOW is actually better. If we start it low, we'll encounter issues in devnet and know what our \"limits\" are. However, if we start it high we may be running at too generous of a buffer and always be too afraid to reduce it.\nThis is also something that seems easier to test with ParamUpdater, since you can play with values quickly while the network is live and see what happens, rather than having to reboot the whole network.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1475492471",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "c405758",
                                                            "authoredDate": "2024-02-01T22:58:30Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "These mempool params seem appropriate as flags. In my view, any consensus variables that require coordination among node operators should be in ParamUpdater probably. Anything that individual nodes can update independently should be flags.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1475493147",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "c405758",
                                                            "authoredDate": "2024-02-01T22:58:30Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "I notice you're ignoring the error here. What it looks like is happening right now is the following:\n0. When we boot up the node before the PoS cut-over height, we will set its PoS params, which will cause us to enter this loop (note that IsRunning() doesn't have a block height check).\n\nBefore the PoS cut-over height, we are calling fasthotStuffConsensus.HandleBlock() -> processBlockPoS -> tryConnectBlockAsNewTip (or whatever it's called), which is erroring because we're not at the cut-over height yet.\nThe error bubbles all the way up to here, where it's ignored.\nEventually, we pass the cut-over height and this stops erroring.\n\nInstead, I recommend the following:\n\nGate this on the cut-over height so we don't enter it until we're supposed to.\nCatch the error here, since it probably means something is messed up.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1475519738",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "c405758",
                                                            "authoredDate": "2024-02-01T22:58:30Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Why not !srv.blockchain.IsPoSBlockHeight here?",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1475522790",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "c405758",
                                                            "authoredDate": "2024-02-01T22:58:30Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Ok, I take it back. It looks like we're smart about calling Start(). In particular, we only call it after we reach the cut-over height height, which means IsRunning() will return false until that point.\nWe should still catch the error here though!",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1475522794",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "c405758",
                                                            "authoredDate": "2024-02-01T22:58:30Z"
                                                        }
                                                    }
                                                },
                                                {
                                                    "node": {
                                                        "bodyText": "I'm walking through the transition from PoW to PoS and I'm running into an issue, which I can't resolve. Based on my analysis, it seems like we should hit a RuleErrorRuleErrorParentBlockHasViewGreaterOrEqualToChildBlock at the PosCutoverHeight2. I'll explain why it looks like this to me, and maybe you can tell me what I'm missing:\ngenesis\n* block_producer.go\n* Miner queries for template with height = Pos2CutoverHeight\n* Finds winning hash\n* Sends it to /submit-block\n* Gets to _handleBlock() with a PoW block that has height << PosCutoverHeight2\n* srv.fastHotStuffConsensus.HandleBlock() is skipped because IsRunning() is not true\n* ProcessBlock calls processBlocPoW because < PosCutoverHeight2\n* block_producer.go and miners get busy producing the next PoW block...\n\nGood so far!\n\n\nPoW height = PoSCutoverHeight - 1\n* A block is mined with height = PoSCutoverHeight - 1\n* Gets to _handleBlock()\n* srv.fastHotStuffConsensus.HandleBlock() is skipped because IsRunning() is not true\n* ProcessBlock calls processBlocPoW because < PosCutoverHeight2\n* block_producer.go and miners get busy producing the next PoW block...\n\nPoW height = PoSCutoverHeight2\n* Here's where it gets weird. Notice that block_producer.go does NOT set ProposedInView to anything, so I assume it's zero for all PoW blocks, including this one.\n* _handleBlock() is called on this last PoW block\n* BUT ProcessBlock calls processBlockPoS because = PosCutoverHeight2\n* We et to -> getLineageFromCommittedTip -> getCommittedTip -> returns PoW block with height = (PosCutoverHeight2 - 1)\n  - This works because all PoW blocks return IsCommitted() = true. Still good so far...\n* Where we get screwed is I think we end up returning RuleErrorParentBlockHasViewGreaterOrEqualToChildBlock in getLineageFromCommittedTip() because we never set the view in any of our PoW blocks.\n\n\nI was searching around to see if maybe we were implicitly setting ProposedInView to the height somewhere but I couldn't find anywhere we were doing it. Not sure how we could ever get past getLineageFromTip() with a PoW block without setting ProposedInView to the right value in the parent.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1475539437",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "c405758",
                                                            "authoredDate": "2024-02-01T22:58:30Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "I see we set ProposedInView here, which is good. But again I'm not seeing how ew get past the error in getLineageFromCommittedTip().",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1475542183",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "c405758",
                                                            "authoredDate": "2024-02-01T22:58:30Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Did some more digging. It looks like you define a MsgDeSoHeader.GetView() that patches the view with the height for HeaderVersion1/0. BUT the code in getLineageFromTip() still looks wrong because it's calling block.Header.ProposedInview. Will keep reading...",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1475543506",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "c405758",
                                                            "authoredDate": "2024-02-01T22:58:30Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Mystery solved. Before the line that checks ProposedInView in getCommittedTip(), there is this line, which breaks out of the for loop:\nif currentBlock.Hash.IsEqual(highestCommittedBlock.Hash) {\n    break\n\nThis results in an empty ancestors list being returned, which is what we expect.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1475551088",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "c405758",
                                                            "authoredDate": "2024-02-01T22:58:30Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Love it! Could add a line saying: Mathematically: A' = A \u2216 A \u2229 B and B' = B \u2216 A \u2229 B",
                                                        "author": {
                                                            "login": "AeonSw4n"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1474926672",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "e205050",
                                                            "authoredDate": "2024-02-01T16:34:08Z"
                                                        }
                                                    }
                                                },
                                                {
                                                    "node": {
                                                        "bodyText": "*equal",
                                                        "author": {
                                                            "login": "AeonSw4n"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1474979739",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "e205050",
                                                            "authoredDate": "2024-02-01T16:34:08Z"
                                                        }
                                                    }
                                                },
                                                {
                                                    "node": {
                                                        "bodyText": "*defined",
                                                        "author": {
                                                            "login": "AeonSw4n"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1475121718",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "e205050",
                                                            "authoredDate": "2024-02-01T16:34:08Z"
                                                        }
                                                    }
                                                },
                                                {
                                                    "node": {
                                                        "bodyText": "Should we change the oldestAllowedTipTime to less than 24h (bc.params.MaxTipAge) for PoS? It feels like 24 hours of blocks in PoS are much more outdated than 24 hours of PoW blocks.",
                                                        "author": {
                                                            "login": "AeonSw4n"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1475600728",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "c405758",
                                                            "authoredDate": "2024-02-01T22:58:30Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Sounds good. I'll catch and log the error here",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1476189294",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "c405758",
                                                            "authoredDate": "2024-02-01T22:58:30Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "We need to start the FastHotStuffConsensus once the chain has connected the final PoW block, which has a height of ProofOfStake2ConsensusCutoverBlockHeight - 1. The final PoW block is the genesis block for the PoS chain, on top of which the PoS consensus votes or times out on",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1476212949",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "c405758",
                                                            "authoredDate": "2024-02-01T22:58:30Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Seems fine to me. I'll update these to ParamUpdater params",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1476239258",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "c405758",
                                                            "authoredDate": "2024-02-01T22:58:30Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Sounds good. Will move these to ParamUpdater too",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1476239765",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "c405758",
                                                            "authoredDate": "2024-02-01T22:58:30Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Resolved in PR #1005",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1476539821",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "c405758",
                                                            "authoredDate": "2024-02-01T22:58:30Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Should we replace this with IsPoSBlockHeight for consistency?",
                                                        "author": {
                                                            "login": "AeonSw4n"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1476564259",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "b2f03f4",
                                                            "authoredDate": "2024-02-02T16:16:29Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Yeah, this line is safe. I updated it to set ProposedInView: finalPoWBlock.Header.GetView() so it's clearer too",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1476618384",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "c405758",
                                                            "authoredDate": "2024-02-01T22:58:30Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Resolved in PR #1009",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1476645021",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "b2f03f4",
                                                            "authoredDate": "2024-02-02T16:16:29Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Clarified the comment further in PR #1010",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1476691065",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "c405758",
                                                            "authoredDate": "2024-02-01T22:58:30Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Can you simplify this as simply:\nif tipHeight < cc.params.GetFinalPoWBlockHeight()\n\nlike you have in server.go?",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1477121496",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "I would explain a bit more of the \"why\" here. I think we're doing this because it's the easiest way to special-case our QC validation logic at the cutover height. But just explain it so we know/remember.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1477122059",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Every time I hit \"Go to Definition\" for one of these, it takes me here rather than to the implementation. Even hitting \"Show Usages\" doesn't take me there. Is there an easy way to jump directly to the implementation that I'm not aware of?",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1477144463",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "I don't think there's any way for this to be incorrect but just to be safe I would replace all instances of Header.ProposedInview with GetView(), including this instance here.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1477172508",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "We shouldn't rely on a timeSource anymore. For context, Bitcoin has a really weird way of dealing with time that we sortof emulated before, but that we're not going to be porting over to PoS.\nFor PoS, we want to simply set the block timestamp to:\ncurrentTimestamp = MIN(time.UnixNano(), parentBlock.TstampNanos + 1)\nCritically, the nodes on the network should allow for some amount of drift, say a few minutes, but should reject blocks outside of that strict time range. Bitcoin does this rejection but its window is 2 hours or so, and it does not enforce monotonically increasing timestamps, which causes complications (it would be better if it did).\nI remember we decided that monotonically increasing the timestamp would prevent attacks, but now that I'm thinking about it I'm not 100% sure we need it. It prevents attacks in Proof of Work because the timestamp is used by Proof of Work to adjust the difficulty, but I don't think we rely explicitly on the timestamp for anything in consensus itself, and so I think just having it be currentTimestamp = time.UnixNano() would probably work. In this case, a validator can fudge the time up to our strict time window for one block, but then the next validator would correct it.\nThe above being said, I recommend keeping monotonically increasing timestamps unless we have a good reason not to have them. Among other things, they lead to more consistent behavior for things that rely on the timestamp, such as lockups. In the specific example of lockups, you could have a weird case where a lockup is unlockable for one block but not unlockable for the next, which is kinda dumb (though not fatal).\nSo I would just leave a comment explaining as much as you can about the relevant context above.\nAlso just as a history lesson, I believe Bitcoin Core sets its timestamp based on the median of what its peers tell it the time is or something like that. I don't know if it still does this, but I think that's how Satoshi had it. It prevents your clock from drifting too hard from everyone else's clock, so that you're always suggesting blocks that are within their window.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1477174191",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Make sure that the mempool cannot accept a txn above this size or it will sit in the mempool forever being skipped by the block producer.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1477174956",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "I think I mentioned this earlier. Can't remember what the decision was though.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1477179728",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "c405758",
                                                            "authoredDate": "2024-02-01T22:58:30Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "I think if this fails, then newView is compromised and you have to recompute it before you go to the next iteration. Maybe what I would do to keep it light is set copiedView, err = newView.CopyUtxoView() and run this check on copiedView to guarantee newView is always clean. And then if it passes you do newView = copiedView like above.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1477184560",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "You don't need to hold the lock when you're making a copy. Rewrite this as follows:\nvar readOnlyPointer *UtxoView\nmp.augmentedLatestBlockViewMutex.RLock()\nreadOnlyPointer = mp.augmentedLatestBlockViewMutex\nmp.augmentedLatestBlockViewMutex.RUnlock()\n\nnewView, err := readOnlyPointer.CopyUtxoView()\n\nNote that we can do this because, unlike with the legacy mempool, we are never modifying augmentedLatestBlockView ever. This seems like a small change, but I think it will dramatically increase efficiency because it means we're almost never holding the lock. This change is also the reason why I recommend we decrease the wait time between recomputations of the augmented view.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1477185165",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "For symmetry, I'd make this augmentedBlockViewRefreshIntervalMillis / 10 so that it checks faster if you update that variable.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1477185451",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "I'd like to start this value at 10ms. I don't think it will cause locking issues here the way it does with legacy mempool because here we hold the write-lock only to make a pointer-copy. In theory, that means we really could set this value to zero and probably be fine. But 10ms seems like a good middle-ground that users hopefully won't really notice.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1477185598",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "I'd rename this to readOnlyAugmentedLatestBlockView since we actually never modify it. Instead, we just always throw away the old one and let it get garbage-collected.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1477185644",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "I don't think you need to hold the lock during the copy. I would rewrite this as:\nmp.RLock()\nreadOnlyPointer = mp.readOnlyLatestBlockView\nmp.RUnblock()\n\nnewView, err := readOnlyPointer.CopyUtxoView()\n\nThis works because we never modify the value of readOnlyLatestView. Instead, we just change the pointer. So you only need to guard the pointer access, not the copy.\nI've always used locks for these cases, but a pointer-copy is so chill I thought maybe Go made it so that it's guaranteed to be atomic. And I think on most hardware the pointer-copy IS atomic, meaning you don't even need a lock around it. But it looks like it's not a guarantee so best to keep the guard you have there.\nThis was my research:\nhttps://chat.openai.com/share/f8aade6f-7822-484a-9057-f656f7429669\nhttps://www.reddit.com/r/golang/comments/yb1ijr/race_or_not_race/",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1477186869",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "A minor note to help you understand my other comments: This field is truly readOnly now, meaning that we don't ever modify the underlying view after we set it. Instead, we just change the pointer to point to a new view. This means that the code for updating this value, as well as the augmentedLatestBlockView value, is much more efficient than it was with the legacy mempool. The reason is that the legacy mempool used to require a view-copy to be inside of a lock, whereas we only need a pointer-copy to be inside of a lock. Much better than before! Which means we can have a lower time between each update. I recommend 10ms.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1477187098",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "I don't think you want BlockUntilReadOnlyViewRegenerated here. I think _addTxn is called when we initialize the mempool, which means you'll be blasting it with txns. Instead, you want to do this wait in BroadcastTransaction() only, which is where it was before anyway. You can just look at the diff and make sure that the position of BlockUntilReadOnlyViewRegenerated hasn't changed, and make sure it makes sense why it hasn't changed.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1477187686",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Update: Resolved this myself.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1477191363",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Update: Resolved this myself.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1477191416",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Update: Resolved this myself.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1477191430",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Update: Resolved this myself.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1477191454",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Update: Resolved this myself.",
                                                        "author": {
                                                            "login": "diamondhands0"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1477191487",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Nice find. This pointer copy is definitely more optimal",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1478412290",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "The event loop is referenced as the interface type. So, no there isn't a a built-in way to go to the implementation directly in VS Code. You'd have to Ctrl+Shift+F to search for it.",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1478475608",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "The interface is useful so we can test the consensus using a mock event loop type. Marking this as resolved since it's not a code issue, and is instead an IDE limitation",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1478476597",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Done",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1478485183",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Marking this as resolved since there's no action item for this feature PR on it.",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1478490750",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "10c2aa5",
                                                            "authoredDate": "2024-01-19T18:03:35Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "This is resolved by the PoS mempool's new augment view refresh async job",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1478491522",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "84a22d2",
                                                            "authoredDate": "2024-01-10T17:32:07Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "We settled on having strictly increasing block timestamps with up to a 10 minute forward buffer. It should not be possible for a block proposer to roll back time with a previously proposed block. This would break the integrity of lockups, among what I'm sure will be other edge cases built on future assumptions of strictly increasing timestamps in other use cases.\nI'll update this to get rid of the timeSource, and to introduce strictly increasing timestamps.",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1478858734",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "The GetView() is a convenience when accepting incoming PoW blocks so that we can use block height as a pseudo \"view\". IMO, it's more appropriate to use the raw ProposedInView field here when constructing and validating blocks. This way, there's no way we can misread and conflate the block height as the view.",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1478940909",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Addressed in PR #1016",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1479058560",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "a428965",
                                                            "authoredDate": "2024-02-02T21:30:45Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "APPROVED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": []
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "I don't have a strong opinion on this. An optional check on the 0x prefix seems fine to add later on when needed. This uses the standard BIP39 seed phrase -> seed conversion, so it should just work out of the box to use a hex seed encoding",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1481959657",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "c405758",
                                                            "authoredDate": "2024-02-01T22:58:30Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Tracking this separately as a TODO for node syncing optimizations",
                                                        "author": {
                                                            "login": "tholonious"
                                                        },
                                                        "url": "https://github.com/deso-protocol/core/pull/875#discussion_r1481972361",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "c405758",
                                                            "authoredDate": "2024-02-01T22:58:30Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                }
                            ]
                        }
                    },
                    "textMatches": [
                        {
                            "property": "comments.body"
                        }
                    ]
                },
                {
                    "node": {
                        "number": 138,
                        "title": "chat\u7528\u306eE2E\u30c6\u30b9\u30c8\u3092\u62e1\u5145\u3001REST API\u3067\u5165\u5ba4\u3057\u305f\u969b\u306bwebsocket\u306eroom\u306b\u3082join\u3059\u308b\u306a\u3069",
                        "repository": {
                            "nameWithOwner": "usatie/pong",
                            "primaryLanguage": {
                                "name": "TypeScript"
                            }
                        },
                        "createdAt": "2023-12-15T08:05:50Z",
                        "mergedAt": "2023-12-15T08:44:56Z",
                        "url": "https://github.com/usatie/pong/pull/138",
                        "state": "MERGED",
                        "author": {
                            "login": "usatie"
                        },
                        "editor": {
                            "login": "coderabbitai"
                        },
                        "body": "\u3053\u3061\u3089\u3060\u3051\u3067\u3082\u5c11\u3057\u5927\u304d\u304f\u306a\u3063\u3066\u3057\u307e\u3063\u305f\u306e\u3067\u3001EventEmitter\u3092\u5229\u7528\u3059\u308b\u3088\u3046\u306b\u3059\u308b\u5909\u66f4\u306f\u6b21\u306ePR\u3067\u3084\u308b\u65b9\u304c\u3044\u3044\u304b\u306a\u3068\u601d\u3063\u3066\u3044\u307e\u3059\u3002\r\nhttps://docs.nestjs.com/techniques/events\r\n\r\n- Add verifyAccessToken method to AuthService\r\n- Add handleConnection and handleDisconnect to ChatService\r\n- Enhance e2e test for chat gateway\r\n\r\n<!-- This is an auto-generated comment: release notes by coderabbit.ai -->\n## Summary by CodeRabbit\n\n## Summary by CodeRabbit\n\n- **New Features**\n  - Enhanced chat functionality with the ability to verify user access and manage chat rooms.\n  - Implemented new message creation and handling within chat rooms.\n  - Added user authentication for chat services.\n\n- **Improvements**\n  - Chat services now support user connections and disconnections.\n  - Rooms module now integrates with chat features for a seamless user experience.\n\n- **Bug Fixes**\n  - Fixed issues related to user authentication in chat services.\n\n- **Documentation**\n  - Updated instructions for chat usage and room management in end-user guides.\n\n- **Tests**\n  - Added end-to-end tests for chat gateway to ensure reliable messaging and room interactions.\n<!-- end of auto-generated comment: release notes by coderabbit.ai -->",
                        "reviews": {
                            "edges": [
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "Review Status\nActionable comments generated: 11\nConfiguration used: CodeRabbit UI\n\nCommits\nFiles that changed from the base of the PR and between 98be248 and 0b2bd0d.\n\n\nFiles selected for processing (8)\n\nbackend/src/auth/auth.module.ts (1 hunks)\nbackend/src/auth/auth.service.ts (2 hunks)\nbackend/src/chat/chat.gateway.ts (2 hunks)\nbackend/src/chat/chat.module.ts (1 hunks)\nbackend/src/chat/chat.service.ts (1 hunks)\nbackend/src/room/room.controller.ts (2 hunks)\nbackend/src/room/room.module.ts (1 hunks)\nbackend/test/chat-gateway.e2e-spec.ts (4 hunks)\n\n\nAdditional comments: 9\nbackend/src/auth/auth.module.ts (1)\n\n33-33: The change to export AuthService from AuthModule is correct and aligns with the PR objectives to enhance module interdependencies and authentication capabilities.\n\n\nbackend/src/auth/auth.service.ts (2)\n\n\n46-57: The implementation of verifyAccessToken looks correct. It uses jwtService.verify to validate the token and throws a NotFoundException if the user does not exist, which aligns with the PR objectives and the AI-generated summary.\n\n\n16-16: The import of jwtConstants is used correctly in the verifyAccessToken method to provide the publicKey for token verification.\n\n\n\nbackend/src/chat/chat.module.ts (2)\n\n\n14-14: The change to export ChatService aligns with the PR objectives to enhance the chat functionality and is correctly reflected in the module's decorator.\n\n\n13-13: The inclusion of AuthModule in the imports array is consistent with the PR objectives to integrate authentication into the chat functionalities.\n\n\n\nbackend/src/room/room.module.ts (2)\n\n\n5-10: The addition of ChatModule to the RoomModule imports is consistent with the PR objectives to integrate chat functionalities into room-related features.\n\n\n5-10: Verify that the addition of ChatModule does not introduce circular dependencies with RoomModule or other modules.\n\n\n\nVerification successful\nThe previous script contained an error due to the use of an unrecognized flag -Ttypescript with rg. I will correct the script and execute it again to verify the potential circular dependencies.\n\nThe output indicates that RoomModule is used within app.module.ts, but it does not provide direct evidence of a circular dependency between RoomModule and ChatModule. To verify the presence of a circular dependency, I need to check if ChatModule also imports RoomModule. I will create a script to search for instances where RoomModule is imported in the files that import ChatModule.\n\nThe script failed because of an incorrect regex pattern. I will correct the regex to properly search for instances of RoomModule being imported in files that import ChatModule.\n\nThe output indicates that RoomModule is imported in app.module.ts, which is the same file that was identified earlier. However, there is no new evidence of RoomModule being imported in any file that imports ChatModule. This suggests that there is no direct circular dependency between RoomModule and ChatModule based on the information available.\nGiven the results, it appears that the addition of ChatModule to RoomModule does not introduce any circular dependencies, at least not in the direct manner that would be detectable with the provided search.\n\n\nScripts Executed\nThe following scripts were executed for the analysis:\n\nScript:\n#!/bin/bash\n# Check for potential circular dependencies involving RoomModule and ChatModule\nrg -Ttypescript \"ChatModule\" --files-with-matches | xargs rg -Ttypescript \"RoomModule\"\n\nLength of output: 154\n\n\nScript:\n#!/bin/bash\n# Check for potential circular dependencies involving RoomModule and ChatModule\nrg \"ChatModule\" --files-with-matches | xargs rg \"RoomModule\"\n\nLength of output: 234\n\n\nScript:\n#!/bin/bash\n# Search for RoomModule imports within files that import ChatModule\nrg \"ChatModule\" --files-with-matches | xargs rg \"import {.*RoomModule.*}\"\n\nLength of output: 187\n\n\nScript:\n#!/bin/bash\n# Search for RoomModule imports within files that import ChatModule\nrg \"ChatModule\" --files-with-matches | xargs rg \"import.*RoomModule\"\n\nLength of output: 143\n\n\nbackend/test/chat-gateway.e2e-spec.ts (2)\n\n218-234: > Note: This review was outside the patches, so it was mapped to the patch with the greatest overlap. Original lines [176-258]\n\nThe commented-out code blocks for test cases related to [joinRoom], [block], [unblock], and other functionalities should be addressed. If these tests are no longer relevant, consider removing the commented-out code to keep the codebase clean. If they are to be implemented later, add a TODO with a clear description or create an issue in the project's issue tracker to track this work.\n\n155-173: The commented-out test case for getting all messages in a room seems to be an important part of the chat functionality testing. If this test is intended to be implemented later, please add a TODO with a clear description or create an issue in the project's issue tracker. If it's no longer needed, consider removing the commented-out code.",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "The createMessage method is currently a placeholder with commented-out code. Ensure that the implementation is tracked and completed, or remove the placeholder if it's not needed.",
                                                        "author": {
                                                            "login": "coderabbitai"
                                                        },
                                                        "url": "https://github.com/usatie/pong/pull/138#discussion_r1427675765",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "0b2bd0d",
                                                            "authoredDate": "2023-12-15T08:03:21Z"
                                                        }
                                                    }
                                                },
                                                {
                                                    "node": {
                                                        "bodyText": "The deleteRoom and sendToRoom methods contain commented-out TODOs. Confirm that these methods are on the roadmap for implementation and are tracked appropriately.",
                                                        "author": {
                                                            "login": "coderabbitai"
                                                        },
                                                        "url": "https://github.com/usatie/pong/pull/138#discussion_r1427675768",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "0b2bd0d",
                                                            "authoredDate": "2023-12-15T08:03:21Z"
                                                        }
                                                    }
                                                },
                                                {
                                                    "node": {
                                                        "bodyText": "The CreateMessageDto class is defined in the global scope. Consider moving it inside the ChatGateway class or to a separate DTO file if it is intended to be used across different parts of the application.",
                                                        "author": {
                                                            "login": "coderabbitai"
                                                        },
                                                        "url": "https://github.com/usatie/pong/pull/138#discussion_r1427675774",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "0b2bd0d",
                                                            "authoredDate": "2023-12-15T08:03:21Z"
                                                        }
                                                    }
                                                },
                                                {
                                                    "node": {
                                                        "bodyText": "The room check in handleMessage uses client.rooms.has(data.roomId.toString()), but elsewhere in the code, rooms are referred to with a 'room/' prefix. This inconsistency may cause the check to fail.\n- if (!client.rooms.has(data.roomId.toString())) {\n+ if (!client.rooms.has('room/' + data.roomId.toString())) {\n\n\n\n\nCommittable suggestion\n\n\u2757 IMPORTANT\nCarefully review the code before committing. Ensure that it accurately replaces the highlighted code, contains no missing lines, and has no issues with indentation.\n\n  \n    \n      \n        Suggested change\n      \n    \n    \n      \n          \n            \n                if (!client.rooms.has(data.roomId.toString())) {\n          \n          \n            \n                if (!client.rooms.has('room/' + data.roomId.toString())) {",
                                                        "author": {
                                                            "login": "coderabbitai"
                                                        },
                                                        "url": "https://github.com/usatie/pong/pull/138#discussion_r1427675777",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "0b2bd0d",
                                                            "authoredDate": "2023-12-15T08:03:21Z"
                                                        }
                                                    }
                                                },
                                                {
                                                    "node": {
                                                        "bodyText": "Consider adding validation for the message content in handleMessage before saving it to the database and emitting it to the room to prevent potential issues with invalid data.",
                                                        "author": {
                                                            "login": "coderabbitai"
                                                        },
                                                        "url": "https://github.com/usatie/pong/pull/138#discussion_r1427675779",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "0b2bd0d",
                                                            "authoredDate": "2023-12-15T08:03:21Z"
                                                        }
                                                    }
                                                },
                                                {
                                                    "node": {
                                                        "bodyText": "The handleMessage method is marked as async but does not handle exceptions that may be thrown by the asynchronous operation this.chatService.createMessage(data). Consider wrapping this call in a try-catch block to handle potential errors gracefully.\n    // Save message to the database\n+   try {\n      await this.chatService.createMessage(data);\n+   } catch (error) {\n+     this.logger.error('Failed to save message:', error);\n+     return;\n+   }\n\n\n\n\nCommittable suggestion\n\n\u2757 IMPORTANT\nCarefully review the code before committing. Ensure that it accurately replaces the highlighted code, contains no missing lines, and has no issues with indentation.\n\n  \n    \n      \n        Suggested change\n      \n    \n    \n      \n          \n            \n              async handleMessage(\n          \n          \n            \n                @MessageBody() data: CreateMessageDto,\n          \n          \n            \n                @ConnectedSocket() client: Socket,\n          \n          \n            \n              ) {\n          \n          \n            \n                this.logger.log(`message: ${data}`);\n          \n          \n            \n                // Check if a user is in the room\n          \n          \n            \n                if (!client.rooms.has(data.roomId.toString())) {\n          \n          \n            \n                  this.logger.error('socket has not joined this room');\n          \n          \n            \n                  return;\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                // Check if the userId is valid\n          \n          \n            \n                if (this.chatService.getUserId(client) !== data.userId) {\n          \n          \n            \n                  this.logger.error('invalid userId');\n          \n          \n            \n                  return;\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                // Save message to the database\n          \n          \n            \n                await this.chatService.createMessage(data);\n          \n          \n            \n            \n          \n          \n            \n                // Send message to the room\n          \n          \n            \n                const room = this.server.to(data.roomId.toString());\n          \n          \n            \n                room.emit('message', data);\n          \n          \n            \n              async handleMessage(\n          \n          \n            \n                @MessageBody() data: CreateMessageDto,\n          \n          \n            \n                @ConnectedSocket() client: Socket,\n          \n          \n            \n              ) {\n          \n          \n            \n                this.logger.log(`message: ${data}`);\n          \n          \n            \n                // Check if a user is in the room\n          \n          \n            \n                if (!client.rooms.has(data.roomId.toString())) {\n          \n          \n            \n                  this.logger.error('socket has not joined this room');\n          \n          \n            \n                  return;\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                // Check if the userId is valid\n          \n          \n            \n                if (this.chatService.getUserId(client) !== data.userId) {\n          \n          \n            \n                  this.logger.error('invalid userId');\n          \n          \n            \n                  return;\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                // Save message to the database\n          \n          \n            \n                try {\n          \n          \n            \n                  await this.chatService.createMessage(data);\n          \n          \n            \n                } catch (error) {\n          \n          \n            \n                  this.logger.error('Failed to save message:', error);\n          \n          \n            \n                  return;\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                // Send message to the room\n          \n          \n            \n                const room = this.server.to(data.roomId.toString());\n          \n          \n            \n                room.emit('message', data);",
                                                        "author": {
                                                            "login": "coderabbitai"
                                                        },
                                                        "url": "https://github.com/usatie/pong/pull/138#discussion_r1427675783",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "0b2bd0d",
                                                            "authoredDate": "2023-12-15T08:03:21Z"
                                                        }
                                                    }
                                                },
                                                {
                                                    "node": {
                                                        "bodyText": "The TODO comment in the create method should be addressed or removed if the corresponding task is completed.\n\n\nEnsure that this.chatService.addUserToRoom is awaited to prevent race conditions and ensure the user is added to the room before the response is returned.\n- 45:   this.chatService.addUserToRoom(res.id, request['user']);\n+ 45:   await this.chatService.addUserToRoom(res.id, request['user']);\n\n\n\n\nCommittable suggestion\n\n\u2757 IMPORTANT\nCarefully review the code before committing. Ensure that it accurately replaces the highlighted code, contains no missing lines, and has no issues with indentation.\n\n  \n    \n      \n        Suggested change\n      \n    \n    \n      \n          \n            \n              async create(@Body() createRoomDto: CreateRoomDto, @Req() request: Request) {\n          \n          \n            \n                const res = await this.roomService.create(createRoomDto, request['user']);\n          \n          \n            \n                // TODO: Add user to room\n          \n          \n            \n                this.chatService.addUserToRoom(res.id, request['user']);\n          \n          \n            \n                return res;\n          \n          \n            \n              async create(@Body() createRoomDto: CreateRoomDto, @Req() request: Request) {\n          \n          \n            \n                const res = await this.roomService.create(createRoomDto, request['user']);\n          \n          \n            \n                // TODO: Add user to room\n          \n          \n            \n                await this.chatService.addUserToRoom(res.id, request['user']);\n          \n          \n            \n                return res;",
                                                        "author": {
                                                            "login": "coderabbitai"
                                                        },
                                                        "url": "https://github.com/usatie/pong/pull/138#discussion_r1427675784",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "0b2bd0d",
                                                            "authoredDate": "2023-12-15T08:03:21Z"
                                                        }
                                                    }
                                                },
                                                {
                                                    "node": {
                                                        "bodyText": "The addUserToRoom call in the createUserOnRoom method should be awaited to ensure that the user is added to the room before the response is returned.\n- 93: this.chatService.addUserToRoom(id, request['user']);\n+ 93: await this.chatService.addUserToRoom(id, request['user']);\n\n\n\n\nCommittable suggestion\n\n\u2757 IMPORTANT\nCarefully review the code before committing. Ensure that it accurately replaces the highlighted code, contains no missing lines, and has no issues with indentation.\n\n  \n    \n      \n        Suggested change\n      \n    \n    \n      \n          \n            \n                const res = await this.roomService.createUserOnRoom(id, request['user']);\n          \n          \n            \n                this.chatService.addUserToRoom(id, request['user']);\n          \n          \n            \n                return res;\n          \n          \n            \n                const res = await this.roomService.createUserOnRoom(id, request['user']);\n          \n          \n            \n                await this.chatService.addUserToRoom(id, request['user']);\n          \n          \n            \n                return res;",
                                                        "author": {
                                                            "login": "coderabbitai"
                                                        },
                                                        "url": "https://github.com/usatie/pong/pull/138#discussion_r1427675785",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "0b2bd0d",
                                                            "authoredDate": "2023-12-15T08:03:21Z"
                                                        }
                                                    }
                                                },
                                                {
                                                    "node": {
                                                        "bodyText": "Consider using a DTO or a decorator to extract the user information from the request in a type-safe manner.",
                                                        "author": {
                                                            "login": "coderabbitai"
                                                        },
                                                        "url": "https://github.com/usatie/pong/pull/138#discussion_r1427675787",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "0b2bd0d",
                                                            "authoredDate": "2023-12-15T08:03:21Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "Review Status\nActionable comments generated: 2\nConfiguration used: CodeRabbit UI\n\nCommits\nFiles that changed from the base of the PR and between 0b2bd0d and f1b8bc5.\n\n\nFiles selected for processing (2)\n\nbackend/src/chat/chat.module.ts (1 hunks)\nbackend/src/chat/chat.service.ts (1 hunks)\n\n\n\nFiles skipped from review as they are similar to previous changes (1)\n\nbackend/src/chat/chat.module.ts\n\n\nAdditional comments: 4\nbackend/src/chat/chat.service.ts (4)\n\n\n16-18: The AuthService is now being injected into the ChatService. Ensure that the AuthService is properly provided in the module where ChatService is declared.\n\n\n21-23: The clients and users maps are used to manage WebSocket connections and user information. Verify that the usage of these maps is thread-safe and that there are no data races, especially if the service can be accessed concurrently.\n\n\n88-108: The handleConnection method correctly extracts the token and uses the AuthService to validate it. Ensure that the error handling is robust and that any exceptions thrown are handled gracefully by the WebSocket gateway.\n\n\n111-113: The handleDisconnect method removes the client from the clients and users maps. Confirm that this cleanup is sufficient and that there are no additional resources that need to be released upon disconnection.",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "There are several TODO comments in the code related to creating messages and deleting rooms. Determine if these are placeholders for future implementation or if they need to be addressed before merging this pull request.",
                                                        "author": {
                                                            "login": "coderabbitai"
                                                        },
                                                        "url": "https://github.com/usatie/pong/pull/138#discussion_r1427686120",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "f1b8bc5",
                                                            "authoredDate": "2023-12-15T08:21:18Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "Review Status\nActionable comments generated: 6\nConfiguration used: CodeRabbit UI\n\nCommits\nFiles that changed from the base of the PR and between f1b8bc5 and fa95e86.\n\n\nFiles selected for processing (6)\n\nbackend/src/chat/chat.controller.spec.ts (1 hunks)\nbackend/src/chat/chat.gateway.ts (2 hunks)\nbackend/src/chat/chat.service.spec.ts (1 hunks)\nbackend/src/chat/chat.service.ts (1 hunks)\nbackend/src/chat/dto/craete-message.dto.ts (1 hunks)\nbackend/src/room/room.controller.ts (2 hunks)\n\n\n\nFiles skipped from review due to trivial changes (1)\n\nbackend/src/chat/chat.gateway.ts\n\n\nAdditional comments: 6\nbackend/src/chat/chat.controller.spec.ts (2)\n\n\n5-6: The addition of AuthService and JwtService to the providers array is consistent with the PR objectives to enhance authentication within the chat module.\n\n\n11-17: The testing module setup using beforeEach and the retrieval of ChatController from the module are correctly implemented.\n\n\n\nbackend/src/chat/chat.service.spec.ts (3)\n\n\n4-5: The imports for AuthService and JwtService are correctly added to support the new authentication functionalities within the ChatService.\n\n\n12-12: The inclusion of AuthService and JwtService in the providers array is appropriate for setting up the testing environment with the necessary dependencies.\n\n\n1-15: While the setup for the ChatService tests has been updated to include the new dependencies, ensure that new tests have been added to cover the enhanced functionalities as mentioned in the PR objectives.\n\n\n\nVerification successful\n\nThe shell script output confirms the presence of multiple E2E test cases in the chat-gateway.e2e-spec.ts file. These tests cover various chat functionalities such as connecting to the chat server, creating and entering rooms, sending and receiving messages, and joining rooms, which align with the PR objectives to enhance E2E testing for the chat gateway.\nBased on this information, it appears that the PR's objectives regarding the expansion of E2E tests have been met.\n\n\nScripts Executed\nThe following scripts were executed for the analysis:\n\nScript:\n#!/bin/bash\n# Search for new test cases related to AuthService and JwtService in the chat.service.spec.ts file.\nrg 'it\\(.*AuthService.*|.*JwtService.*' backend/src/chat/chat.service.spec.ts\n\nLength of output: 193\n\n\nScript:\n#!/bin/bash\n# Search for all test cases in the chat.service.spec.ts file to see if new tests have been added.\nrg 'it\\(' backend/src/chat/chat.service.spec.ts\n\nLength of output: 83\n\n\nScript:\n#!/bin/bash\n# Search for test cases in the chat-gateway.e2e-spec.ts file to verify the presence of new E2E tests.\nrg 'it\\(' backend/src/chat/chat-gateway.e2e-spec.ts\n\nLength of output: 135\n\n\nScript:\n#!/bin/bash\n# Search for the chat-gateway.e2e-spec.ts file in the repository to find its correct path.\nfd 'chat-gateway.e2e-spec.ts'\n\nLength of output: 67\n\n\nScript:\n#!/bin/bash\n# Search for test cases in the chat-gateway.e2e-spec.ts file to verify the presence of new E2E tests.\nrg 'it\\(' backend/test/chat-gateway.e2e-spec.ts\n\nLength of output: 1305\n\n\nbackend/src/room/room.controller.ts (1)\n\n34-37: The addition of ChatService to the RoomController constructor is consistent with the PR objectives to enhance chat functionality integration.",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "Consider adding validation to ensure roomId and userId are positive integers, as negative values or zero are typically not valid identifiers.\n  @IsNumber()\n+ @Min(1)\n  @ApiProperty()\n  roomId: number;\n\n  @IsNumber()\n+ @Min(1)\n  @ApiProperty()\n  userId: number;\n\n\n\n\nCommittable suggestion\n\n\u2757 IMPORTANT\nCarefully review the code before committing. Ensure that it accurately replaces the highlighted code, contains no missing lines, and has no issues with indentation.\n\n  \n    \n      \n        Suggested change\n      \n    \n    \n      \n          \n            \n              @IsNumber()\n          \n          \n            \n              @ApiProperty()\n          \n          \n            \n              roomId: number;\n          \n          \n            \n            \n          \n          \n            \n              @IsNumber()\n          \n          \n            \n              @ApiProperty()\n          \n          \n            \n              userId: number;\n          \n          \n            \n              @IsNumber()\n          \n          \n            \n              @Min(1)\n          \n          \n            \n              @ApiProperty()\n          \n          \n            \n              roomId: number;\n          \n          \n            \n            \n          \n          \n            \n              @IsNumber()\n          \n          \n            \n              @Min(1)\n          \n          \n            \n              @ApiProperty()\n          \n          \n            \n              userId: number;",
                                                        "author": {
                                                            "login": "coderabbitai"
                                                        },
                                                        "url": "https://github.com/usatie/pong/pull/138#discussion_r1427708084",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "fa95e86",
                                                            "authoredDate": "2023-12-15T08:41:04Z"
                                                        }
                                                    }
                                                },
                                                {
                                                    "node": {
                                                        "bodyText": "The create method correctly implements asynchronous behavior to handle room creation and user addition to the chat room. However, the call to this.chatService.addUserToRoom should be awaited to ensure the user is added before the response is returned.\n- 44: this.chatService.addUserToRoom(res.id, req.user);\n+ 44: await this.chatService.addUserToRoom(res.id, req.user);\n\n\n\n\nCommittable suggestion\n\n\u2757 IMPORTANT\nCarefully review the code before committing. Ensure that it accurately replaces the highlighted code, contains no missing lines, and has no issues with indentation.\n\n  \n    \n      \n        Suggested change\n      \n    \n    \n      \n          \n            \n              async create(@Body() createRoomDto: CreateRoomDto, @Req() req: { user }) {\n          \n          \n            \n                const res = await this.roomService.create(createRoomDto, req.user);\n          \n          \n            \n                this.chatService.addUserToRoom(res.id, req.user);\n          \n          \n            \n                return res;\n          \n          \n            \n              async create(@Body() createRoomDto: CreateRoomDto, @Req() req: { user }) {\n          \n          \n            \n                const res = await this.roomService.create(createRoomDto, req.user);\n          \n          \n            \n                await this.chatService.addUserToRoom(res.id, req.user);\n          \n          \n            \n                return res;",
                                                        "author": {
                                                            "login": "coderabbitai"
                                                        },
                                                        "url": "https://github.com/usatie/pong/pull/138#discussion_r1427708087",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "fa95e86",
                                                            "authoredDate": "2023-12-15T08:41:04Z"
                                                        }
                                                    }
                                                },
                                                {
                                                    "node": {
                                                        "bodyText": "The import for CreateMessageDto has a typo in the filename (craete-message.dto instead of create-message.dto).\n- import { CreateMessageDto } from './dto/craete-message.dto';\n+ import { CreateMessageDto } from './dto/create-message.dto';\n\n\n\n\nCommittable suggestion\n\n\u2757 IMPORTANT\nCarefully review the code before committing. Ensure that it accurately replaces the highlighted code, contains no missing lines, and has no issues with indentation.\n\n  \n    \n      \n        Suggested change\n      \n    \n    \n      \n          \n            \n            import {\n          \n          \n            \n              Injectable,\n          \n          \n            \n              ConflictException,\n          \n          \n            \n              UnauthorizedException,\n          \n          \n            \n            } from '@nestjs/common';\n          \n          \n            \n            import { CreateDirectMessageDto } from './dto/create-direct-message.dto';\n          \n          \n            \n            import { PrismaService } from 'src/prisma/prisma.service';\n          \n          \n            \n            import { User } from '@prisma/client';\n          \n          \n            \n            import { Socket } from 'socket.io';\n          \n          \n            \n            import { WebSocketGateway } from '@nestjs/websockets';\n          \n          \n            \n            import { AuthService } from 'src/auth/auth.service';\n          \n          \n            \n            import {\n          \n          \n            \n              Injectable,\n          \n          \n            \n              ConflictException,\n          \n          \n            \n              UnauthorizedException,\n          \n          \n            \n            } from '@nestjs/common';\n          \n          \n            \n            import { CreateDirectMessageDto } from './dto/create-direct-message.dto';\n          \n          \n            \n            import { PrismaService } from 'src/prisma/prisma.service';\n          \n          \n            \n            import { User } from '@prisma/client';\n          \n          \n            \n            import { Socket } from 'socket.io';\n          \n          \n            \n            import { WebSocketGateway } from '@nestjs/websockets';\n          \n          \n            \n            import { AuthService } from 'src/auth/auth.service';",
                                                        "author": {
                                                            "login": "coderabbitai"
                                                        },
                                                        "url": "https://github.com/usatie/pong/pull/138#discussion_r1427708094",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "fa95e86",
                                                            "authoredDate": "2023-12-15T08:41:04Z"
                                                        }
                                                    }
                                                },
                                                {
                                                    "node": {
                                                        "bodyText": "Ensure proper error handling in handleConnection. Catching the error and logging it without rethrowing or handling it might cause silent failures.",
                                                        "author": {
                                                            "login": "coderabbitai"
                                                        },
                                                        "url": "https://github.com/usatie/pong/pull/138#discussion_r1427708096",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "fa95e86",
                                                            "authoredDate": "2023-12-15T08:41:04Z"
                                                        }
                                                    }
                                                },
                                                {
                                                    "node": {
                                                        "bodyText": "The createMessage and deleteRoom methods are placeholders and need to be implemented.",
                                                        "author": {
                                                            "login": "coderabbitai"
                                                        },
                                                        "url": "https://github.com/usatie/pong/pull/138#discussion_r1427708098",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "fa95e86",
                                                            "authoredDate": "2023-12-15T08:41:04Z"
                                                        }
                                                    }
                                                },
                                                {
                                                    "node": {
                                                        "bodyText": "The comment about receiverId validation from a previous review has not been addressed. This needs to be resolved to ensure message sending is authorized.",
                                                        "author": {
                                                            "login": "coderabbitai"
                                                        },
                                                        "url": "https://github.com/usatie/pong/pull/138#discussion_r1427708101",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "fa95e86",
                                                            "authoredDate": "2023-12-15T08:41:04Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "authentication\u306fcontroller/gateway\u3067\u3084\u308b\u306e\u304c\u901a\u4f8b\u304b\u3068\u601d\u3063\u305f\u308a\nhttps://chat.openai.com/share/3918b060-510b-4b3e-a94a-7cfaf1e2f996",
                                                        "author": {
                                                            "login": "takumihara"
                                                        },
                                                        "url": "https://github.com/usatie/pong/pull/138#discussion_r1429054015",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "fa95e86",
                                                            "authoredDate": "2023-12-15T08:41:04Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "node": {
                                        "state": "COMMENTED",
                                        "bodyText": "",
                                        "comments": {
                                            "edges": [
                                                {
                                                    "node": {
                                                        "bodyText": "\u3053\u308c\u3063\u3066\u52d5\u304d\u307e\u3059\uff1f",
                                                        "author": {
                                                            "login": "takumihara"
                                                        },
                                                        "url": "https://github.com/usatie/pong/pull/138#discussion_r1429055734",
                                                        "originalCommit": {
                                                            "abbreviatedOid": "fa95e86",
                                                            "authoredDate": "2023-12-15T08:41:04Z"
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                }
                            ]
                        }
                    },
                    "textMatches": [
                        {
                            "property": "comments.body"
                        },
                        {
                            "property": "body"
                        }
                    ]
                }
            ],
            "pageInfo": {
                "endCursor": "Y3Vyc29yOjMy",
                "hasNextPage": false,
                "hasPreviousPage": true,
                "startCursor": "Y3Vyc29yOjMx"
            },
            "issueCount": 32
        }
    }
}